name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Windows SDK
        run: |
          choco install visualstudio2022buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64" -y

      - name: Install dependencies (ignore node-irsdk failure)
        continue-on-error: true
        run: npm install --ignore-scripts

      - name: Install non-native dependencies
        run: npm install ws pkg

      - name: Download and fix node-irsdk
        shell: pwsh
        run: |
          # Download node-irsdk source
          npm pack node-irsdk@2.1.6

          # Extract
          tar -xf node-irsdk-2.1.6.tgz

          # Fix BOM in binding.gyp
          $bindingPath = "package\binding.gyp"
          $content = Get-Content $bindingPath -Raw
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText($bindingPath, $content, $utf8NoBom)
          Write-Host "Fixed BOM in binding.gyp"

          # Move to node_modules
          if (!(Test-Path "node_modules")) { New-Item -ItemType Directory -Path "node_modules" }
          if (Test-Path "node_modules\node-irsdk") { Remove-Item -Recurse -Force "node_modules\node-irsdk" }
          Move-Item "package" "node_modules\node-irsdk"

          # Clean up
          Remove-Item "node-irsdk-2.1.6.tgz"

      - name: Install node-gyp globally
        run: npm install -g node-gyp

      - name: Build node-irsdk
        run: |
          cd node_modules\node-irsdk
          npm install --ignore-scripts
          node-gyp rebuild

      - name: Build executable
        run: npm run build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: RacingIntelligenceCompanion
          path: dist/RacingIntelligenceCompanion.exe

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/RacingIntelligenceCompanion.exe
          body: |
            # Racing Intelligence Companion ${{ github.ref_name }}

            **Download and run - no installation needed!**

            ## üéØ What's This?
            The Racing Intelligence Companion streams live iRacing telemetry to the OPR Intelligence web application.

            ## üì¶ Installation
            1. Download `RacingIntelligenceCompanion.exe` below
            2. Double-click to run
            3. Launch iRacing and join a session
            4. Open the Live Calculator in OPR Intelligence
            5. See real-time fuel data, lap times, and pit strategy!

            ## ‚ú® Features
            - Real-time fuel levels and consumption
            - Live lap timing
            - Automatic pit stop predictions
            - Lap history tracking
            - Zero configuration required

            ## üñ•Ô∏è Requirements
            - Windows (64-bit)
            - iRacing subscription
            - OPR Intelligence account

            ## üîí Security Note
            Windows may show a SmartScreen warning because this app is unsigned. Click "More info" ‚Üí "Run anyway" to proceed. The app is safe and open source.

            ## üìñ Documentation
            See the [README](https://github.com/${{ github.repository }}/blob/main/README.md) for more details.

            ---

            üèÅ **Happy Racing!**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
